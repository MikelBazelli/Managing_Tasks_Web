<!--  Viewing Tasks Page -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Tasks</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/ViewTasks.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  
</head>

<body>

<!-- Nav Bar  -->
<header>
    <nav class="navbar navbar-expand-sm ">
        <div class="container-fluid ">
            <a class="navbar-brand fs-5" href="viewTasks.html">HOME</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-sm-0">
                    <li class="nav-item">
                        <a class="nav-link fs-5 px-2 link-body-emphasis" href="viewTasks.html">View Tasks</a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link fs-5 px-2 link-body-emphasis" href="#" data-bs-toggle="modal" data-bs-target="#newTaskModal">New Task</a>
                  </li>
                  
                    <li class="nav-item d-sm-none">
                        <a href="#" class="nav-link fs-5 px-2 dropdown-toggle link-body-emphasis" data-bs-toggle="dropdown" aria-expanded="false">
                            Welcome!
                        </a>
                        <ul class="dropdown-menu text-small">
                            <li><a class="dropdown-item" href="#" id="logoutButton">Logout</a></li>
                        </ul>
                    </li>
                </ul>
                  <!-- Show the dropdown when pc screen size. 
                 Was fascing an error, and I cam up with solution to make the message 2 times, and hide one when pc screen and show the other when on mobile -->     
                <div class="d-none d-sm-block ms-auto">
                    <div class="dropdown">
                        <a href="#" class="nav-link fs-5 px-2 dropdown-toggle link-body-emphasis text-decoration-none" data-bs-toggle="dropdown" aria-expanded="false">
                            Welcome!
                        </a>
                        <ul class="dropdown-menu text-small">
                            <li><a href="#" class="nav-link link-dark" id="logoutButton">
                            Log out</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>
</header>


<!-- SIDE BAR -->

<div class="container-fluid">
    <div class="row">

        <!-- Sidebar (visible on larger screens), using bootstrap-->
        <div class="col-auto d-none d-md-flex flex-column flex-shrink-0 p-3 min-vh-100 sidebar" id="sidebar">
            <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto link-dark text-decoration-none">
                <span class="fs-4">ManageWeb</span>
            </a>
            <hr>
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item">
                    <a href="viewTasks.html" class="nav-link link-dark">
                        Home
                    </a>
                </li>
                <li>
                    <a href="viewTasks.html" class="nav-link link-dark">
                        View Tasks
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link link-dark" data-bs-toggle="modal" data-bs-target="#newTaskModal">
                        New Task
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link link-dark" id="logoutButton">
                    Log out
                    </a>
                </li>
            </ul>
            <hr>
        </div>

        <!-- Main content -->
        <div class="col d-flex flex-column p-4">
            <div class="toggle-sidebar-container">
                <button class="toggle-sidebar material-symbols-outlined" id="sidebarToggle">arrow_forward</button>
            </div>
            <main class="flex-grow-1">
                <div class="album py-5 bg-body-tertiary">
                    <div class="container">
                        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3" id="tasksContainer">

                            <!-- Cards will be dynamically be inserted here -->

                        </div>
                    </div>
                </div>
            </main>

            <!-- Footer, non functional lins -->
            <footer class="py-3 my-4">
                <ul class="nav justify-content-center border-bottom pb-3 mb-3">
                    <li class="nav-item"><a href="#" class="nav-link px-2 text-body-secondary">Home</a></li>
                    <li class="nav-item"><a href="#" class="nav-link px-2 text-body-secondary">Features</a></li>
                    <li class="nav-item"><a href="#" class="nav-link px-2 text-body-secondary">Pricing</a></li>
                    <li class="nav-item"><a href="#" class="nav-link px-2 text-body-secondary">FAQs</a></li>
                    <li class="nav-item"><a href="#" class="nav-link px-2 text-body-secondary">About</a></li>
                </ul>
                <p class="text-center text-body-secondary">Â© 2024 Company, Inc</p>
            </footer>
        </div>
    </div>
</div>

<!-- Offcanvas Sidebar (visible on smaller screens), using bootstrap -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasWithBothOptions" aria-labelledby="offcanvasWithBothOptionsLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasWithBothOptionsLabel">ManageWeb</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
                <a href="viewTasks.html" class="nav-link link-dark">
                    Home
                </a>
            </li>
            <li>
                <a href="viewTasks.html" class="nav-link link-dark">
                    View Tasks
                </a>
            </li>
            <li>
                <a href="#" class="nav-link link-dark" data-bs-toggle="modal" data-bs-target="#newTaskModal">
                    New Task
                </a>
            </li>
            <li>
                <a href="#" class="nav-link link-dark" id="logoutButton">
                    Log out
                </a>
            </li>
        </ul>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="taskModalLabel">Task Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <!-- View Mode -->
        <div id="viewMode">
          <h5 id="taskTitle"></h5>
          <p id="taskDescription"></p>
          <p id="taskContent"></p>
          <small id="taskCreatedAt"></small>
        </div>

        <!-- Edit Mode -->
        <div id="editMode" style="display: none;">
          <form id="editTaskForm">
            <div class="mb-3">
              <label for="editTitle" class="form-label">Title</label>
              <input type="text" class="form-control" id="editTitle">
            </div>
            <div class="mb-3">
              <label for="editDescription" class="form-label">Description</label>
              <textarea class="form-control" id="editDescription"></textarea>
            </div>
            <div class="mb-3">
              <label for="editContent" class="form-label">Content</label>
              <textarea class="form-control" id="editContent"></textarea>
            </div>
            <input type="hidden" id="taskId">
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- New Task Modal -->
<div class="modal fade" id="newTaskModal" tabindex="-1" aria-labelledby="newTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="newTaskModalLabel">Create New Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="newTaskForm">
            <div class="mb-3">
              <label for="newTitle" class="form-label">Title</label>
              <input type="text" class="form-control" id="newTitle" required>
            </div>
            <div class="mb-3">
              <label for="newDescription" class="form-label">Description</label>
              <textarea class="form-control" id="newDescription" required></textarea>
            </div>
            <div class="mb-3">
              <label for="newContent" class="form-label">Content</label>
              <textarea class="form-control" id="newContent" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Create Task</button>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>



<script>
/*Adding an event Listener */
document.addEventListener('DOMContentLoaded', function () {
    const tasksContainer = document.getElementById('tasksContainer');
    const taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
    const viewMode = document.getElementById('viewMode');
    const editMode = document.getElementById('editMode');
    const editTaskForm = document.getElementById('editTaskForm');
    const newTaskModal = new bootstrap.Modal(document.getElementById('newTaskModal'));
    const sidebarToggle = document.getElementById('sidebarToggle');
    const offcanvas = new bootstrap.Offcanvas(document.getElementById('offcanvasWithBothOptions'));
    const sidebar = document.getElementById('sidebar');
    const newTaskForm = document.getElementById('newTaskForm');
    
    let currentTask = null;

    // Fetch tasks and display them as cards
    function fetchTasks() {
        fetch('/tasks').then(response => response.json()).then(tasks => {
                tasksContainer.innerHTML = ''; 
                tasks.forEach(task => {
                    const createdAt = new Date(task.created_at);
                    const formattedDate = `${createdAt.getFullYear()}-${String(createdAt.getMonth() + 1).padStart(2, '0')}-${String(createdAt.getDate()).padStart(2, '0')}`;
                    
                    /*Wrapping each task inside bootstrap tags to print them in html cards*/
                    const card = document.createElement('div');
                    card.className = 'col-md-4 mb-4';
                    card.innerHTML = 
                     ` <div class="card shadow-sm" data-task-id="${task.id}">
                            <div class="card-body">
                                <h5 class="card-title">${task.title}</h5>
                                <p class="card-text">${task.description}</p>
                                <p class="card-text">${task.content}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#taskModal" data-task='${JSON.stringify(task)}'>View</button>
                                        <button type="button" class="btn btn-sm btn-primary" data-task='${JSON.stringify(task)}'>Edit</button>
                                        <button type="button" class="btn btn-sm btn-danger" data-task-id="${task.id}">Delete</button>
                                    </div>
                                    <small class="text-body-secondary">${formattedDate}</small>
                                </div>
                            </div>
                        </div>`;
                      tasksContainer.appendChild(card);
                });

               /*Event listener to task cards*/
                tasksContainer.addEventListener('click', function (event) {
                    const button = event.target.closest('.btn');
                   /* If no button was clicked, exit the function */
                    if (!button) return;

                    /* Parsing the task data from the button's 'data-task' attribute */
                    const task = JSON.parse(button.getAttribute('data-task'));
                    const taskId = button.getAttribute('data-task-id');
                    currentTask = task;

                    /*Handling card's buttons when clicked, and run each function based on the id*/
                    if (button.matches('.btn-success')) {
                        showTaskInModal(task, false);
                    } else if (button.matches('.btn-primary')) {
                        showTaskInModal(task, true);
                    } else if (button.matches('.btn-danger')) {
                        deleteTask(taskId);
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching tasks:', error);
                alert('You have no tasks, Create!');
            });
    }

    fetchTasks();

/* Function to display task details in a modal, either for viewing or editing */
    function showTaskInModal(task, isEditMode) {
        if (isEditMode) { //modal name
           /* Setting the values of the form fields for editing */
            document.getElementById('editTitle').value = task.title;
            document.getElementById('editDescription').value = task.description;
            document.getElementById('editContent').value = task.content;
            document.getElementById('taskId').value = task.id;
            viewMode.style.display = 'none';// Hiding the view mode section
            editMode.style.display = 'block';// Show the edit mode section
        } else { /* If not in edit mode, display task details for viewing */
            document.getElementById('taskTitle').textContent = task.title;
            document.getElementById('taskDescription').textContent = task.description;
            document.getElementById('taskContent').textContent = task.content;
            document.getElementById('taskCreatedAt').textContent = `Created At: ${new Date(task.created_at).toLocaleDateString()}`;
            viewMode.style.display = 'block';
            editMode.style.display = 'none';
        }
      
       // Showing the modal
        taskModal.show();
    }

    /* Handling The updating tasks */
    editTaskForm.addEventListener('submit', function (event) {
        event.preventDefault();
        const updatedTask = {
            title: document.getElementById('editTitle').value,
            description: document.getElementById('editDescription').value,
            content: document.getElementById('editContent').value
        };

        const taskId = document.getElementById('taskId').value;

        fetch(`/updateTasks/${taskId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedTask)
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(text);
                });
            }
            return response.json();
        })
        .then(result => {
            console.log('Task updated successfully');
            taskModal.hide();
            setTimeout(() => {
                fetchTasks();
            }, 500);
        })
        .catch(error => {
            console.error('Error:', error.message);
            alert('Error updating task. Please try again!');
        });
    });
 
    /* Deleting the Tasks */
    function deleteTask(taskId) {
        fetch(`/deleteTasks/${taskId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { throw new Error(text) });
            }
            fetchTasks();
        })
        .catch(error => {
            console.error('Error:', error.message);
            alert('Task Deleted Successfully!');
        });
    }

    /* Creating A new task */
    newTaskForm.addEventListener('submit', function (event) {
        event.preventDefault();
        const newTask = {
            title: document.getElementById('newTitle').value,
            description: document.getElementById('newDescription').value,
            content: document.getElementById('newContent').value
        };
        /* Using post */
        fetch('/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(newTask)
        }).then(response => {
            if (!response.ok) { //if error from the backend show error message
                return response.text().then(text => {
                    throw new Error(text);
                });
            }
            return response.json();
        }).then(result => {
            console.log('Task created successfully');
            newTaskModal.hide();
            fetchTasks();
        }).catch(error => { /* Was fascing an error, 
            when creating tasks,  page will not refresh and show error, so i altered the error message and page has to be refreshed manually in order tp view the new created task */
            console.error('Error:', error.message);
            alert('Task Created!, Refresh page to view changes');
        });
    });

     // logoutS function
     function handleLogout() {
        fetch('/logout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Logout failed');
            }
            window.location.href = '/html/login.html';  // re-direct to login page after successfull log out
        })
        .catch(error => {
            console.error('Error:', error.message);
            alert('Error logging out. Please try again!');
        });
    }

    //Event listener to all logout buttons
    document.querySelectorAll('#logoutButton').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            handleLogout();
        });
    });

      /* Arrow button functionality */
      sidebarToggle.addEventListener('click', function () {
        if (window.innerWidth < 768) {
            offcanvas.toggle();
        }
    });
    
    /* Displaying button and side bar based on screen size*/
    function checkScreenSize() {
        if (window.innerWidth < 768) {
            sidebar.style.display = 'none';
            sidebarToggle.style.display = 'inline-block';
        } else {
            sidebar.style.display = 'flex';
            sidebarToggle.style.display = 'none';
        }
    }

    window.addEventListener('load', checkScreenSize);
    window.addEventListener('resize', checkScreenSize);

 

});


</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
